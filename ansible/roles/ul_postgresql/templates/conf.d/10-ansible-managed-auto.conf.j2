#
# {{ ansible_managed }}
#
# This file is automatically generated by ul_postgresql.
#
# Parameters managed by this file are those generally modified when setting
# PostgreSQL. Defaults are sensible one based on Ansible provided facts, but can
# be overwritten by changing variables values.
#
# To overwrite freely and/or to add unsuported parameters by this template, use
# ul_postgresql_custon_conf variable.
#

#--------------------------------
# CONNECTIONS AND AUTHENTICATION
#--------------------------------

listen_addresses                = '*'
max_connections                 = {{ ul_postgresql_max_connections }}
superuser_reserved_connections  = {{ ul_postgresql_superuser_reserved_connections }}
port                            = {{ ul_postgresql_port }}
ssl                             = {{ 'on' if ul_postgresql_ssl else 'off' }}
password_encryption             = scram-sha-256
ssl_cert_file                   = '{{ ul_postgresql_ssl_cert_file | default('server.crt') }}'
ssl_key_file                    = '{{ ul_postgresql_key_cert_file | default('server.key') }}'

#--------------------------------
# RESOURCE USAGE (except WAL)
#--------------------------------

shared_buffers       = {{ ul_postgresql_shared_buffers }}
temp_buffers         = {{ ul_postgresql_temp_buffers }}
work_mem             = {{ ul_postgresql_work_mem }}
maintenance_work_mem = {{ ul_postgresql_maintenance_work_mem }}

effective_io_concurrency         = {{ 200 if ansible_product_version.startswith('Hyper-V') else 1 }}
max_worker_processes             = {{ ansible_processor_cores }}
{% if ul_postgresql_version is version('11', '>=') %}
max_parallel_maintenance_workers = {{ (ansible_processor_cores / 2) | round(0, 'ceil') | int }}
{% endif %}
max_parallel_workers             = {{ ansible_processor_cores }}
max_parallel_workers_per_gather  = {{ (ansible_processor_cores / 2) | round(0, 'ceil') | int }}

#--------------------------------
# WRITE-AHEAD LOG
#--------------------------------

checkpoint_timeout            = {{ ul_postgresql_checkpoint_timeout }}
max_wal_size                  = {{ ul_postgresql_max_wal_size }}
min_wal_size                  = {{ ul_postgresql_min_wal_size }}
checkpoint_completion_target  = {{ ul_postgresql_checkpoint_completion_target }}

archive_mode                  = {{ ul_postgresql_archive_mode }}
archive_command               = '{{ ul_postgresql_archive_command }}'

#--------------------------------
# QUERY TUNING
#--------------------------------

random_page_cost     = {{ ul_postgresql_random_page_cost }}
effective_cache_size = {{ ul_postgresql_effective_cache_size }}

#--------------------------------
# REPORTING AND LOGGING
#--------------------------------

log_destination     = 'stderr,csvlog'
log_directory       = '{{ 'log' if ul_postgresql_log_directory == "" }}'
log_filename        = '{{ ul_postgresql_log_filename }}'
log_rotation_age    = {{ ul_postgresql_log_rotation_age }}
log_rotation_size   = {{ ul_postgresql_log_rotation_size }}

log_min_duration_statement  = {{ ul_postgresql_log_min_duration_statement }}
log_checkpoints             = {{ ul_postgresql_log_checkpoints }}
log_connections             = {{ ul_postgresql_log_connections }}
log_disconnections          = {{ ul_postgresql_log_disconnections }}
log_line_prefix             = '{{ ul_postgresql_log_line_prefix }}'
log_lock_waits              = {{ ul_postgresql_log_lock_waits }}
log_statement               = '{{ ul_postgresql_log_statement }}'
log_temp_files              = {{ ul_postgresql_log_temp_files }}

#------------------------------------------------------------------------------
# STATISTICS
#------------------------------------------------------------------------------

track_io_timing           = {{ ul_postgresql_track_io_timing }}
track_functions           = {{ ul_postgresql_track_functions }}
track_activity_query_size = {{ ul_postgresql_track_activity_query_size }}

#------------------------------------------------------------------------------
# AUTOVACUUM
#------------------------------------------------------------------------------

log_autovacuum_min_duration = 0
autovacuum_max_workers      = {{ [ (ansible_processor_cores / 2) | round(0, 'ceil') | int, 3] | min }}

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------

shared_preload_libraries = '{{ ul_postgresql_shared_preload_libraries | join(',') }}'
