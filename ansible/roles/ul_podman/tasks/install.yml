---

- name: "YUM | Install dependencies"
  yum:
    name: "{{ ul_podman_dependencies }}"
    state: present

- name: "YUM | Install PODMAN"
  yum:
    name: "{{ ul_podman_packages }}"
    state: present

# The Kubic repo recently pushed a more tailored containers.conf but it breaks
# things. Basically this step deploys the file packaged with an older version
# of containers-common (containers-common-1.2.0-3.el7.x86_64.rpm)
# See GitHub issue => https://github.com/containers/podman/issues/8430
# TODO: Skip this step and try to overwrite runc with its most recent version
# See https://github.com/containers/podman/issues/8430#issuecomment-733067424

- name: "FILE | Restore the older version of containers.conf"
  file:
    src: usr/share/containers/containers.conf
    dest: /usr/share/containers/containers.conf
    owner: root
    group: root
    mode: 0644
    setype: usr_t
    seuser: system_u
    serole: object_r

# Creates a new SELinux rule to allow cron to spawn containers (denied by default)
# - name: FILE | Ensure /etc/selinux/coda19 is here
#   file:
#     name: /etc/selinux/coda19
#     state: directory
#     mode: 0755
#     owner: root
#     group: root
#
# - name: COPY | Copy cron2container_transition_allow.te
#   copy:
#     src: etc/selinux/coda19/cron2container_transition_allow.te
#     dest: /etc/selinux/coda19/cron2container_transition_allow.te
#
# - name: SHELL | Compile and insert cron2container_transition_allow
#   shell: |
#     checkmodule -M -m -o /etc/selinux/coda19/cron2container_transition_allow.mod /etc/selinux/coda19/cron2container_transition_allow.te
#     semodule_package -o /etc/selinux/coda19/cron2container_transition_allow.pp -m /etc/selinux/coda19/cron2container_transition_allow.mod
#     semodule -i /etc/selinux/coda19/cron2container_transition_allow.pp
