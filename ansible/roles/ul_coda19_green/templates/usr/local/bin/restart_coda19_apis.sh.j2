#!/bin/bash

sudo -i -u coda19-learning-api bash << EOF
echo "=== coda19-learning-api cleanup ==="

cd ~
podman rmi --force docker.io/coda19/coda19-learning-api:latest
podman system prune --all --force && podman rmi --all
kill $(netstat -tulpn | grep ":{{ coda19_learning_api_port }}" | sed "s/.*LISTEN\(.*\)\/node.*/\1/" | sed -e 's/^[ \t]*//')

EOF
echo "=== coda19-learning-api cleanup finished ==="

sudo -i -u coda19-stats-api bash << EOF
echo "=== coda19-stats-api cleanup ==="

cd ~
podman rmi --force docker.io/coda19/coda19-stats-api:latest
podman system prune --all --force && podman rmi --all
kill $(netstat -tulpn | grep ":{{ coda19_stats_api_port }}" | sed "s/.*LISTEN\(.*\)\/node.*/\1/" | sed -e 's/^[ \t]*//')

EOF
echo "=== coda19-stats-api cleanup finished ==="

sudo -i -u coda19-site-api bash << EOF
echo "=== coda19-site-api cleanup ==="

cd ~
podman rmi --force docker.io/coda19/coda19-site-api:latest
podman system prune --all --force && podman rmi --all
kill $(netstat -tulpn | grep ":{{ coda19_site_api_port }}" | sed "s/.*LISTEN\(.*\)\/node.*/\1/" | sed -e 's/^[ \t]*//')

EOF
echo "=== coda19-site-api cleanup finished ==="