#!/bin/bash
#
# {{ ansible_managed }}
#

#### CODA19-LEARNING-API

echo "=== coda19-learning-api cleanup ==="
systemctl stop coda19-learning-api
sudo -i -u coda19-learning-api bash << EOF
cd ~
PID=$( netstat -tulpn | grep ":{{ coda19_learning_api_port }}" | sed "s/.*LISTEN\(.*\)\/node.*/\1/" | sed -e 's/^[ \t]*//' )
kill -15 $PID
sleep 5
kill -9 $PID
podman rmi --force docker.io/coda19/coda19-learning-api:latest
podman system prune --all --force && podman rmi --all
EOF
echo "=== coda19-learning-api cleanup finished ==="

#### CODA19-STATS-API

echo "=== coda19-stats-api cleanup ==="
systemctl stop coda19-stats-api
sudo -i -u coda19-stats-api bash << EOF
cd ~
PID=$( netstat -tulpn | grep ":{{ coda19_stats_api_port }}" | sed "s/.*LISTEN\(.*\)\/node.*/\1/" | sed -e 's/^[ \t]*//' )
kill -15 $PID
sleep 5
kill -9 $PID
podman rmi --force docker.io/coda19/coda19-stats-api:latest
podman system prune --all --force && podman rmi --all
EOF
echo "=== coda19-stats-api cleanup finished ==="

#### CODA19-SITE-API

echo "=== coda19-site-api cleanup ==="
systemctl stop coda19-site-api
sudo -i -u coda19-site-api bash << EOF
cd ~
PID=$( netstat -tulpn | grep ":{{ coda19_site_api_port }}" | sed "s/.*LISTEN\(.*\)\/node.*/\1/" | sed -e 's/^[ \t]*//' )
kill -15 $PID
sleep 5
kill -9 $PID
podman rmi --force docker.io/coda19/coda19-site-api:latest
podman system prune --all --force && podman rmi --all
EOF
echo "=== coda19-site-api cleanup finished ==="
