---
# Creates a database for Aidbox
- name: POSTGRESQL_USER | Create PosgteSQL role for AidBox
  postgresql_user:
    name: "{{ ul_aidbox_db_owner }}"
    # See vault files (password differs between sites), enforce md5 security
    # The REST API do some operations (GRANT, etc) that requires a superuser :(
    password: "{{ 'md5'+((ul_aidbox_db_password+ul_aidbox_db_owner) | hash('MD5')) }}"
    role_attr_flags: LOGIN,SUPERUSER
  become: true
  become_user: postgres

- name: POSTGRESQL_DB | Create database for AidBox
  postgresql_db:
    name: "{{ ul_aidbox_db_name }}"
    owner: "{{ ul_aidbox_db_owner }}"
  become: true
  become_user: postgres

# Sets up a local user 'aidbox' (local group 'aidbox') and its subuid/subgid for a rootless container
# Unfortunately, the 'user' and 'group' modules have no support for subuid/subguid in Ansible 2.9
- name: GROUP | Add the group 'aidbox'
  group:
    name: aidbox
    system: no

- name: USER | Add the user 'aidbox'
  user:
    name: aidbox
    comment: AidBox Service account
    group: aidbox
    system: no

# Where the config stuff goes
- name: FILE | Ensure /etc/aidbox is present
  file:
    dest: /etc/aidbox
    owner: aidbox
    group: aidbox
    mode: 0750
    state: directory

# Generate the file that contains the variables for the REST service container
# TODO: use different credential between sites
- name: TEMPLATE | Generate /etc/aidbox/aidbox_vars
  template:
    src: etc/aidbox/aidbox_vars.j2
    dest: /etc/aidbox/aidbox_vars
    owner: aidbox
    group: aidbox
    mode: 0640

# Only root can write inside /run
- name: FILE | Ensure /run/aidbox is present
  file:
    dest: /run/aidbox
    owner: aidbox
    group: aidbox
    mode: 0750
    state: directory

# Generates the systemd workunit
# Ref.
- name: TEMPLATE | Copy systemd workunit
  template:
    src: etc/systemd/system/aidbox.service.j2
    dest: /etc/systemd/system/aidbox.service
    owner: root
    group: root
    mode: 0664

# On the first start, podman would pull the image however let's do this now
# WARNING: The rest service will connect to a licence server located in the cloud over https (TCP/443)
# and the container will be stuck until the licence key validation passed, if you are behind
# a proxy, use
- name: DOCKER_IMAGE | Pull an official aidbox REST service image
  podman_image:
    name: "{{ ul_aidbox_image }}"
    tag: "{{ ul_aidbox_image_tag }}"
  become: yes
  become_user: aidbox
